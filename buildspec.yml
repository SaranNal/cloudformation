version: 0.2
phases:
  pre_build:
    commands:
      - echo prebuild phase
      - aws --version
      - CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
      - echo "Changed files: $CHANGED_FILES"
      - |
        if echo "$CHANGED_FILES" | grep -q "helper-stack/"; then
          DEPLOY_HELPER=true;
        else
          DEPLOY_HELPER=false;
        fi
      - |
        if echo "$CHANGED_FILES" | grep -q "network-stack/"; then
          DEPLOY_NETWORK=true;
        else
          DEPLOY_NETWORK=false;
        fi
      - |
        if echo "$CHANGED_FILES" | grep -q "infra-stack/"; then
          DEPLOY_INFRA=true;
        else
          DEPLOY_INFRA=false;
        fi

  build:
    commands:
      # Deploy helper-stack if changes are detected
      - |
        if [ "$DEPLOY_HELPER" = true ]; then
          echo "Changes detected in helper-stack. Deploying helper-stack...";
          echo getting existing helper-stack template;
          aws cloudformation get-template --stack-name helper-stack-${CURRENT_STACK_ENV} --output json | jq -rc '.TemplateBody' > CurrentHelperRootstack.yaml;
          cat CurrentHelperRootstack.yaml;
          echo running aws cloudformation command to deploy helper-stack;
          aws cloudformation deploy --no-fail-on-empty-changeset --template-file ./CurrentHelperRootstack.yaml --capabilities=CAPABILITY_NAMED_IAM --disable-rollback --parameter-overrides "Environment"="${Environment}" "ProjectName"="${ProjectName}" "CodeStarConnectionID"="${CodeStarConnectionID}" "StackBucketName"="${CURRENT_TEMPLATE_BUCKET}" "S3LogBucket"="${S3LogBucket}" --stack-name helper-stack-${StackENV};
          echo helper-stack-${StackENV} deploy completed;
        else
          echo "No changes detected in helper-stack. Skipping helper-stack deployment.";
        fi

      # Deploy network-stack if changes are detected
      - |
        if [ "$DEPLOY_NETWORK" = true ]; then
          echo "Changes detected in network-stack. Deploying network-stack...";
          echo getting existing network-stack template;
          aws cloudformation get-template --stack-name network-stack-${CURRENT_STACK_ENV} --output json | jq -rc '.TemplateBody' > CurrentNetworkRootstack.yaml;
          cat CurrentNetworkRootstack.yaml;
          echo running aws cloudformation command to deploy network-stack;
          aws cloudformation deploy --no-fail-on-empty-changeset --template-file ./CurrentNetworkRootstack.yaml --capabilities=CAPABILITY_NAMED_IAM --disable-rollback --parameter-overrides "Environment"="${Environment}" "ProjectName"="${ProjectName}" "CodeStarConnectionID"="${CodeStarConnectionID}" "StackBucketName"="${CURRENT_TEMPLATE_BUCKET}" "SSLCertificateID"="${SSLCertificateID}" --stack-name network-stack-${StackENV};
          echo network-stack-${StackENV} deploy completed;
        else
          echo "No changes detected in network-stack. Skipping network-stack deployment.";
        fi

      # Deploy infra-stack if changes are detected
      - |
        if [ "$DEPLOY_INFRA" = true ]; then
          echo "Changes detected in infra-stack. Deploying infra-stack...";
          echo getting existing infra-stack template;
          aws cloudformation get-template --stack-name infra-stack-${CURRENT_STACK_ENV} --output json | jq -rc '.TemplateBody' > CurrentInfraRootstack.yaml;
          cat CurrentInfraRootstack.yaml;
          echo running aws cloudformation command to deploy infra-stack;
          aws cloudformation deploy --no-fail-on-empty-changeset --template-file ./CurrentInfraRootstack.yaml --capabilities=CAPABILITY_NAMED_IAM --disable-rollback --parameter-overrides "Environment"="${Environment}" "ProjectName"="${ProjectName}" "CodeStarConnectionID"="${CodeStarConnectionID}" "StackBucketName"="${CURRENT_TEMPLATE_BUCKET}" "SSLCertificateID"="${SSLCertificateID}" --stack-name infra-stack-${StackENV};
          echo infra-stack-${StackENV} deploy completed;
        else
          echo "No changes detected in infra-stack. Skipping infra-stack deployment.";
        fi

      - echo running s3 sync command
      - aws s3 sync ./ s3://${CLONE_TEMPLATE_BUCKET}/ --exclude "buildspec-stack-update.yml" --exclude "buildspec.yml" --exclude "CurrentHelperRootstack.yaml" --exclude "CurrentNetworkRootstack.yaml" --exclude "CurrentInfraRootstack.yaml" --exclude ".gitignore"

artifacts:
  files:
    - "**/*"
